  // For information and examples see:
  // https://link.wokwi.com/custom-chips-alpha
  //
  // SPDX-License-Identifier: MIT
  // Copyright (C) 2022 Uri Shaked / wokwi.com

  // https://wokwi.com/makers/urish

  // original project https://wokwi.com/projects/333785509332517459

  #include "wokwi-api.h"
  #include <stdio.h>
  #include <stdlib.h>
  #include <string.h>    // contains strlen() function

  #define LEN(arr) ((int)(sizeof(arr) / sizeof(arr)[0]))    // macro

  #define SECOND 5000000    // micros

  // A NMEA 0183 sentence can have a maximum of 80 characters plus a
  // carriage return and a line feed

  const char gps_tx_data[][80] = { // GPRMC & GPGGA (Hypothetical Data)
    "$GPGGA,234649.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*67\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234649.295,A,1203.651,S,07701.702,W,000.1,016.7,021124,000.0,W*76\r\n",
    "$GPGGA,234650.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234650.295,A,1203.651,S,07701.702,W,000.1,000.0,021124,000.0,W*7E\r\n",
    "$GPGGA,234651.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234651.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7E\r\n",
    "$GPGGA,234652.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234652.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7D\r\n",
    "$GPGGA,234653.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234653.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7C\r\n",
    "$GPGGA,234654.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6B\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234654.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7B\r\n",
    "$GPGGA,234655.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234655.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234656.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*69\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234656.295,A,1203.651,S,07701.702,W,000.4,090.0,021124,000.0,W*74\r\n",
    "$GPGGA,234657.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6B\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234657.295,A,1203.651,S,07701.701,W,000.1,270.0,021124,000.0,W*7F\r\n",
    "$GPGGA,234658.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*64\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234658.295,A,1203.651,S,07701.701,W,000.1,000.0,021124,000.0,W*75\r\n",
    "$GPGGA,234659.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*65\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234659.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*75\r\n",
    "$GPGGA,234700.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234700.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*78\r\n",
    "$GPGGA,234701.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*69\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234701.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*79\r\n",
    "$GPGGA,234702.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234702.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234703.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6B\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234703.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7B\r\n",
    "$GPGGA,234704.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234704.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7C\r\n",
    "$GPGGA,234705.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234705.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7D\r\n",
    "$GPGGA,234706.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234706.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7E\r\n",
    "$GPGGA,234707.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234707.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7F\r\n",
    "$GPGGA,234708.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*60\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234708.295,A,1203.651,S,07701.701,W,000.3,270.0,021124,000.0,W*76\r\n",
    "$GPGGA,234709.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*62\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234709.295,A,1203.651,S,07701.702,W,000.3,000.0,021124,000.0,W*71\r\n",
    "$GPGGA,234710.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234710.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234711.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6B\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234711.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7B\r\n",
    "$GPGGA,234712.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234712.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*78\r\n",
    "$GPGGA,234713.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*69\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234713.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*79\r\n",
    "$GPGGA,234714.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234714.295,A,1203.651,S,07701.702,W,000.2,026.6,021124,000.0,W*7E\r\n",
    "$GPGGA,234715.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234715.295,A,1203.651,S,07701.702,W,000.1,090.0,021124,000.0,W*77\r\n",
    "$GPGGA,234716.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234716.295,A,1203.651,S,07701.701,W,000.2,063.4,021124,000.0,W*7C\r\n",
    "$GPGGA,234717.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234717.295,A,1203.651,S,07701.701,W,000.1,270.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234718.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*61\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234718.295,A,1203.651,S,07701.701,W,000.1,000.0,021124,000.0,W*70\r\n",
    "$GPGGA,234719.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*60\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234719.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*70\r\n",
    "$GPGGA,234720.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6A\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234720.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234721.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*6B\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234721.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*7B\r\n",
    "$GPGGA,234722.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234722.295,A,1203.651,S,07701.701,W,000.0,000.0,021124,000.0,W*78\r\n",
    "$GPGGA,234723.295,1203.651,S,07701.701,W,1,12,1.0,0.0,M,0.0,M,,*69\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234723.295,A,1203.651,S,07701.701,W,000.2,225.0,021124,000.0,W*7E\r\n",
    "$GPGGA,234724.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6D\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234724.295,A,1203.651,S,07701.702,W,000.4,248.2,021124,000.0,W*75\r\n",
    "$GPGGA,234725.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6C\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234725.295,A,1203.651,S,07701.702,W,000.3,225.0,021124,000.0,W*7A\r\n",
    "$GPGGA,234726.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6F\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234726.295,A,1203.651,S,07701.702,W,000.3,000.0,021124,000.0,W*7C\r\n",
    "$GPGGA,234727.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*6E\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234727.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*7E\r\n",
    "$GPGGA,234728.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*61\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234728.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*71\r\n",
    "$GPGGA,234729.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*60\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234729.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*70\r\n",
    "$GPGGA,234730.295,1203.651,S,07701.702,W,1,12,1.0,0.0,M,0.0,M,,*68\r\n",
    "$GPGSA,A,3,01,02,03,04,05,06,07,08,09,10,11,12,1.0,1.0,1.0*30\r\n",
    "$GPRMC,234730.295,A,1203.651,S,07701.702,W,000.0,000.0,021124,000.0,W*78\r\n"
  };


  typedef struct {
    uart_dev_t uart0;
    uint32_t   gps_tx_index;
  } chip_state_t;


  static void chip_timer_event  (void *user_data);


  void chip_init(void) {

    setvbuf(stdout, NULL, _IOLBF, 1024);                // ???     // Disable buffering for debug logs

    chip_state_t *chip = malloc(sizeof(chip_state_t));

    const uart_config_t uart_config = {
      .tx         = pin_init("TX", INPUT_PULLUP),
      .rx         = pin_init("RX", INPUT),
      .baud_rate  = 9600,
      .user_data  = chip,
    };

    chip->uart0        = uart_init(&uart_config);
  
    chip->gps_tx_index = 0;

    const timer_config_t timer_config = {
      .callback  = chip_timer_event,
      .user_data = chip,
    };

    timer_t timer = timer_init(&timer_config);

    timer_start(timer, SECOND, true);

    printf("GPS Chip initialized!\n");         // prints to web browser console (developer tools)

  }

  void chip_timer_event(void *user_data) {

    chip_state_t *chip = (chip_state_t*) user_data;

    printf("chip_timer_event\n");
//  printf ("LEN(gps_tx_data):  %d\n", LEN(gps_tx_data)   );    // number of messages
//  printf ("message length  :  %d\n", strlen(message)    );    // actual message length
//  printf ("gps_tx_index    :  %u\n", chip->gps_tx_index );    // message index

    const char * message = gps_tx_data[chip->gps_tx_index++];

    uart_write(chip->uart0, (uint8_t *) message, strlen(message));

    if (chip->gps_tx_index >= LEN(gps_tx_data)) {       
      chip->gps_tx_index = 0;
    }
  }

